/***************************************************************************************************
 *   Project:
 *   Author:        Stulov Tikhon (kudesnick@inbox.ru)
 ***************************************************************************************************
 *   Distribution:
 *
 ***************************************************************************************************
 *   MCU Family:    STM32F
 *   Compiler:      ARMCC
 ***************************************************************************************************
 *   File:          main.c
 *   Description:
 *
 ***************************************************************************************************
 *   History:       13.04.2019 - file created
 *
 **************************************************************************************************/

/***************************************************************************************************
 *                                      INCLUDED FILES
 **************************************************************************************************/

#include <stdio.h>
#include <stdbool.h>
#include <string.h>
#include "stm32f4xx_hal.h" // Device header
#include "misc_macro.h"
#include "bsp.h"
#include "bsp_spi.h"
#include "bsp_uart.h"
#include "usr_io.h"

/***************************************************************************************************
 *                                       DEFINITIONS
 **************************************************************************************************/

#define V_TAB_SIZE 0x76

/***************************************************************************************************
 *                                      PRIVATE TYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                               PRIVATE FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                       PRIVATE DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                       PUBLIC DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                      EXTERNAL DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                              EXTERNAL FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PRIVATE FUNCTIONS
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PUBLIC FUNCTIONS
 **************************************************************************************************/

#if !defined(__CC_ARM) && defined(__ARMCC_VERSION) && !defined(__OPTIMIZE__)
    /*
    Without this directive, it does not start if -o0 optimization is used and the "main"
    function without parameters.
    see http://www.keil.com/support/man/docs/armclang_mig/armclang_mig_udb1499267612612.htm
    */
    __asm(".global __ARM_use_no_argv\n\t" "__ARM_use_no_argv:\n\t");
#endif

typedef uint32_t v_tab_item_t;
volatile const v_tab_item_t v_tab[V_TAB_SIZE] __attribute__((section("V_TAB_ADDR")));

int main(int argument_count, char **argument_array)
{
    (void)argument_count;
    (void)argument_array;

    for (volatile uint16_t i = 0; i < sizeof(v_tab)/sizeof(v_tab[0]); i++)
    {
        volatile v_tab_item_t *const v_tab_ram = (v_tab_item_t *)v_tab;
        volatile v_tab_item_t *const v_tab_rom = (v_tab_item_t *)SCB->VTOR;
    
        v_tab_ram[i] = v_tab_rom[i];
    }
    SCB->VTOR = (uint32_t)v_tab;

    bsp_init();

    printf("\033[31mC\033[32mO\033[33mL\033[34mO\033[35mR\033[42m \033[0m"
            "\033[36mT\033[37mE\033[30m\033[47mS\033[0mT\n"); // Color test
    usr_put_routine();

    bsp_spi_init();
    bsp_uart_init();

    printf("Run\n");
    usr_put_routine();

    for(;;)
    {
        usr_put_routine();
        __WFI();
    }

    BRK_PTR("Main function terminated.");

    return 0;
}

/***************************************************************************************************
 *                                       END OF FILE
 **************************************************************************************************/
