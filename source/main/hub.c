/***************************************************************************************************
 *   Project:
 *   Author:        Stulov Tikhon (kudesnick@inbox.ru)
 ***************************************************************************************************
 *   Distribution:
 *
 ***************************************************************************************************
 *   MCU Family:    STM32F
 *   Compiler:      ARMCC
 ***************************************************************************************************
 *   File:          hub.c
 *   Description:
 *
 ***************************************************************************************************
 *   History:       2020/04/11 - file created
 *
 **************************************************************************************************/

/***************************************************************************************************
 *                                      INCLUDED FILES
 **************************************************************************************************/

#include <stdio.h>
#include <stdbool.h>

#include "hub.h"
#include "bsp_spi.h"
#include "bsp_uart.h"
#include "misc_macro.h"

/***************************************************************************************************
 *                                       DEFINITIONS
 **************************************************************************************************/

/***************************************************************************************************
 *                                      PRIVATE TYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                               PRIVATE FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                       PRIVATE DATA
 **************************************************************************************************/

bool spi_tx_complete_flag = true;
bool uart_tx_complete_flag[UART_CNT] = 
    {true, true, true, true, true, true, true, true, true, true};

/***************************************************************************************************
 *                                       PUBLIC DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                      EXTERNAL DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                              EXTERNAL FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PRIVATE FUNCTIONS
 **************************************************************************************************/

static bool _crc_calc(uint8_t *const _data)
{
    // CRC-8/SAE-J1850
    // width=8  poly=0x1d  init=0xff  refin=false  refout=false  xorout=0xff  check=0x4b
    static const uint8_t poly   = 0x1d;
    static const uint8_t xorout = 0xff;
    uint8_t crc = 0xff;

    uint8_t len = _data[1];

    for (uint8_t i = 0; i < len; i++)
    {
        crc ^= _data[i]; 
        
        for (uint8_t j = 8; j > 0; --j)
        {
            crc = crc & (1 << 7) ? (crc << 1) ^ poly : crc << 1;
        }
    }

    crc ^= xorout;
    len--;

    bool result = (_data[len] == crc);
    
    _data[len] = crc ^ xorout;
    
    return result;
};

/***************************************************************************************************
 *                                    WEAKLY FUNCTIONS
 **************************************************************************************************/

void bsp_spi_tx_callback(const bool _ok)
{
    spi_tx_complete_flag = _ok;
    
    if (!_ok)
    {
        HUB_PRINTF("<hub> spi tx callback error!");
    }
}

void bsp_uart_tx_callback(const uint8_t _n, const bool _ok)
{
    uart_tx_complete_flag[_n] = _ok;
    
    if (!_ok)
    {
        HUB_PRINTF("<hub> uart#%d tx callback error!", _n);
    }
}

bool bsp_spi_rx_callback(uint8_t *const _data)
{
    
}

bool bsp_uart_rx_callback(uint8_t *const _data)
{
    _data[1]++;
    
    _crc_calc(_data);

#warning add to spi tx
    return true;
}

/***************************************************************************************************
 *                                    PUBLIC FUNCTIONS
 **************************************************************************************************/

void hub_routine(void)
{

}

/***************************************************************************************************
 *                                       END OF FILE
 **************************************************************************************************/
